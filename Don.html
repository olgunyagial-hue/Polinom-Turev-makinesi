import streamlit as st
from openai import OpenAI
from fpdf import FPDF
import tempfile

# 1. AÅAMA: GÄ°RÄ°Å VE AYARLAR
st.set_page_config(page_title="YZ Verimlilik LaboratuvarÄ±", page_icon="ğŸš€")
st.title("ğŸ¤– YZ ile Verimlilik KanÄ±tÄ±")
st.markdown("### El YazÄ±sÄ± veya Ses KaydÄ±nÄ± Akademik PDF'e DÃ¶nÃ¼ÅŸtÃ¼r")

# Dostum, buraya kendi API anahtarÄ±nÄ± girmelisin
client = OpenAI(api_key="SENIN_OPENAI_API_KEYIN")

# 2. AÅAMA: DOSYA YÃœKLEME (MAKSÄ°MUM 10 SAYFA VEYA SES)
uploaded_files = st.file_uploader("DosyalarÄ± BÄ±rakÄ±n (GÃ¶rsel veya Ses)", 
                                  type=['png', 'jpg', 'jpeg', 'mp3', 'wav', 'm4a'], 
                                  accept_multiple_files=True)

target_type = st.radio("Bu nasÄ±l bir not olsun?", ["Ders Notu", "YÃ¶netici Ã–zeti", "SÄ±nav HazÄ±rlÄ±k"])

if st.button("Sihri BaÅŸlat âœ¨") and uploaded_files:
    full_text = ""
    progress_bar = st.progress(0)
    
    with st.spinner('YZ MutfaÄŸÄ±nda iÅŸleniyor...'):
        for i, file in enumerate(uploaded_files):
            # Dosya tÃ¼rÃ¼ne gÃ¶re iÅŸlem (L KURALI)
            if file.type.startswith('image'):
                # GÃ¶rÃ¼ntÃ¼ Ä°ÅŸleme (Vision)
                response = client.chat.completions.create(
                    model="gpt-4o",
                    messages=[{"role": "user", "content": [
                        {"type": "text", "text": f"Bu bir el yazÄ±sÄ± notudur. Bunu {target_type} formatÄ±nda tertemiz dijital metne Ã§evir."},
                        {"type": "image_url", "image_url": {"url": f"data:{file.type};base64,..."}} # Detay basitleÅŸtirildi
                    ]}]
                )
                full_text += response.choices[0].message.content + "\n\n"
            
            elif file.type.startswith('audio'):
                # Ses Ä°ÅŸleme (Whisper)
                with tempfile.NamedTemporaryFile(delete=False, suffix=".mp3") as tmp:
                    tmp.write(file.getvalue())
                    transcript = client.audio.transcriptions.create(model="whisper-1", file=open(tmp.name, "rb"))
                    full_text += transcript.text + "\n\n"
            
            progress_bar.progress((i + 1) / len(uploaded_files))

    # 3. AÅAMA: SUNUM (PDF OLUÅTURMA)
    st.subheader("ğŸ“ YZ TarafÄ±ndan HazÄ±rlanan Metin")
    st.write(full_text)
    
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    pdf.multi_cell(0, 10, txt=full_text)
    
    pdf_output = "YZ_Not_Analizi.pdf"
    pdf.output(pdf_output)

    with open(pdf_output, "rb") as f:
        st.download_button("ğŸ“‚ Profesyonel PDF'i Ä°ndir", f, file_name=pdf_output)
    
    st.success("Dostum, iÅŸte verimlilik bu! 1 saatlik iÅŸi saniyeler iÃ§inde bitirdik. ğŸ‘‹")

elif not uploaded_files:
    st.info("LÃ¼tfen bir dosya yÃ¼kleyerek 'eÅŸyapi' Ã§Ã¶zÃ¼mÃ¼mÃ¼zÃ¼ test edin.")
